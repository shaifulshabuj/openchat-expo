# Master Prompt 003: Phase 2 - Real-Time Chat (1-on-1 Messaging)

**Date:** 2026-02-04 19:52 JST  
**Phase:** Phase 2 - Real-Time Chat (Week 7-12 of 20)  
**Type:** Phase  
**Estimated Duration:** 5-6 weeks  
**Codex Tasks:** 16 atomic tasks

---

## ğŸ¯ Objective

Implement a complete real-time messaging system for OpenChat Expo, enabling users to send and receive text messages, share media (images, videos, files, voice), react to messages, edit/delete messages, and search through conversation history. This phase builds upon the authentication system from Phase 1 and establishes the core communication features that make OpenChat a functional messaging application.

Upon completion, users will be able to:
- Send and receive text messages in real-time using Socket.io
- See message read receipts (delivered/seen status)
- View typing indicators when others are typing
- React to messages with emojis
- Edit sent messages (with edit history)
- Delete messages (soft delete)
- Forward messages to other contacts
- Reply to specific messages (threading/quoting)
- Mention other users with @username
- Search through message history with full-text search
- Share images from camera or gallery
- Share videos with upload progress
- Share files (documents, PDFs, etc.)
- Send voice messages with recording UI
- Queue messages when offline for later delivery
- Pin important messages to top of chat

---

## ğŸ“‹ Context

### Current State:
- âœ… Phase 0 complete (Project Scaffolding - 100%)
- âœ… Phase 1 complete (Authentication & User Management - 100%)
- âœ… JWT authentication working (access + refresh tokens)
- âœ… User registration, login, profile management operational
- âœ… Expo mobile app with auth screens
- âœ… NestJS backend with tRPC configured
- âœ… Prisma schema with 14 models (including Message, Conversation, MessageReaction)
- âœ… Docker Compose with PostgreSQL + Redis running
- âœ… Session management with Redis
- âŒ No messaging functionality implemented yet
- âŒ No Socket.io real-time communication
- âŒ No media upload/download system
- âŒ No message database operations

### Desired State:
- âœ… Socket.io server and client configured with authentication
- âœ… Real-time message sending/receiving working
- âœ… Message persistence in PostgreSQL via Prisma
- âœ… Read receipts tracking (delivered/seen timestamps)
- âœ… Typing indicators with debouncing
- âœ… Message reactions (emoji picker and display)
- âœ… Message editing with edit history
- âœ… Message deletion (soft delete, "Message deleted" placeholder)
- âœ… Message forwarding to multiple recipients
- âœ… Message replies/threading with quoted original
- âœ… User mentions (@username) with notifications
- âœ… Message pinning to chat header
- âœ… Full-text message search (PostgreSQL FTS)
- âœ… Image sharing via expo-image-picker (camera/gallery)
- âœ… Video sharing with S3/Cloudinary upload
- âœ… File sharing via expo-document-picker
- âœ… Voice messages via expo-av (record/play)
- âœ… Offline message queue with AsyncStorage
- âœ… Message list with virtualization (FlatList)
- âœ… Chat list with last message preview
- âœ… All 16 Phase 2 features complete

### Why This Master Prompt:
- **Core Value:** Messaging is the primary feature of a chat application
- **User Engagement:** Real-time communication drives user retention
- **Foundation for Groups:** 1-on-1 messaging must work before group chats
- **Critical Path:** Contacts (Phase 3) and Groups (Phase 4) depend on this
- **Market Parity:** Must match features of competitors (WhatsApp, Telegram)
- **Real-Time Architecture:** Establishes WebSocket patterns for all future features
- **Media Handling:** File upload/download infrastructure for social features

---

## ğŸ§© Task Decomposition

This master prompt breaks down into 16 Codex tasks:

### **BACKEND TASKS (Tasks 28-35, ~6.5 hours)**

### Codex Task 28: Socket.io Real-Time Infrastructure
- **File:** `CODEX_028_20260204.prompts.md` (to be created)
- **What:** Install Socket.io, create WebSocket gateway with JWT auth, presence tracking
- **Files:** 5 files (socket.module.ts, socket.gateway.ts, socket.service.ts, etc.)
- **Time:** 60 minutes
- **Status:** NOT STARTED
- **Dependencies:** Phase 1 complete (JWT auth, User model)

### Codex Task 29: Message Model & Database Schema
- **File:** `CODEX_029_20260205.prompts.md` (to be created)
- **What:** Update Prisma schema for Message, Conversation, MessageReaction models + migrations
- **Files:** 4 files (schema.prisma updates, migrations/, seed data)
- **Time:** 45 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 28

### Codex Task 30: Message tRPC Procedures (CRUD)
- **File:** `CODEX_030_20260205.prompts.md` (to be created)
- **What:** Create message.send, getHistory, markAsRead, edit, delete, search procedures
- **Files:** 4 files (message.router.ts, message.service.ts, DTOs, validation)
- **Time:** 60 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 29

### Codex Task 31: Real-Time Events (Socket.io)
- **File:** `CODEX_031_20260206.prompts.md` (to be created)
- **What:** Implement Socket.io events (message:sent, message:read, typing:start/stop, user:online/offline)
- **Files:** 3 files (socket.gateway.ts updates, event handlers, Redis integration)
- **Time:** 45 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 28, 30

### Codex Task 32: Message Reactions System
- **File:** `CODEX_032_20260206.prompts.md` (to be created)
- **What:** Create reaction model, tRPC procedures (add/remove), Socket.io events
- **Files:** 4 files (reaction.router.ts, schema updates, migration, socket events)
- **Time:** 35 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 30

### Codex Task 33: Media Upload Service (S3/Cloudinary)
- **File:** `CODEX_033_20260207.prompts.md` (to be created)
- **What:** S3 or Cloudinary integration, upload endpoints, file validation, thumbnail generation
- **Files:** 5 files (upload.service.ts, upload.controller.ts, config, validation, types)
- **Time:** 75 minutes
- **Status:** NOT STARTED
- **Dependencies:** None (parallel with Task 30)

### Codex Task 34: Message Search & Filtering
- **File:** `CODEX_034_20260207.prompts.md` (to be created)
- **What:** PostgreSQL full-text search, filter by content/sender/date/type, pagination
- **Files:** 3 files (search.service.ts, search procedures, Prisma indexes)
- **Time:** 50 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 30

### Codex Task 35: Offline Message Queue (Backend)
- **File:** `CODEX_035_20260208.prompts.md` (to be created)
- **What:** Store undelivered messages, delivery tracking, retry logic, deliver on reconnect
- **Files:** 4 files (queue.service.ts, Redis queue logic, delivery tracking, events)
- **Time:** 50 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 28, 31

---

### **MOBILE TASKS (Tasks 36-43, ~7.5 hours)**

### Codex Task 36: Socket.io Client Setup
- **File:** `CODEX_036_20260209.prompts.md` (to be created)
- **What:** Install socket.io-client, create SocketContext, handle connection/disconnection/reconnection
- **Files:** 4 files (SocketContext.tsx, socket.ts client, hooks, integration with AuthContext)
- **Time:** 45 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 28 (backend Socket.io ready)

### Codex Task 37: Chat List Screen
- **File:** `CODEX_037_20260209.prompts.md` (to be created)
- **What:** List all conversations, last message preview, unread badges, online status, pull-to-refresh
- **Files:** 3 files (chat-list.tsx, ConversationItem component, tRPC integration)
- **Time:** 60 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 30, 36

### Codex Task 38: Chat Screen (Conversation View)
- **File:** `CODEX_038_20260210.prompts.md` (to be created)
- **What:** Message list with FlatList virtualization, message bubbles, timestamps, read receipts, scroll-to-bottom
- **Files:** 5 files (chat.tsx, MessageBubble component, InputBar component, styles, types)
- **Time:** 90 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 30, 31, 36

### Codex Task 39: Message Input & Sending
- **File:** `CODEX_039_20260210.prompts.md` (to be created)
- **What:** Multiline text input, send button, emoji picker button, attachment menu, typing indicator trigger
- **Files:** 3 files (InputBar component updates, emoji integration, message sending logic)
- **Time:** 45 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 38

### Codex Task 40: Image & Video Sharing
- **File:** `CODEX_040_20260211.prompts.md` (to be created)
- **What:** expo-image-picker integration, camera vs gallery, preview before send, upload progress
- **Files:** 4 files (MediaPicker component, ImagePreview, VideoPreview, upload hooks)
- **Time:** 60 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 33 (upload service), 39

### Codex Task 41: File & Voice Messages
- **File:** `CODEX_041_20260211.prompts.md` (to be created)
- **What:** expo-document-picker, expo-av audio recording, record/stop/play controls, waveform, validation
- **Files:** 5 files (FilePicker, VoiceRecorder, AudioPlayer, waveform component, upload)
- **Time:** 75 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 33, 39

### Codex Task 42: Message Interactions (Edit/Delete/Reply/Forward)
- **File:** `CODEX_042_20260212.prompts.md` (to be created)
- **What:** Long-press menu, edit inline, delete confirmation, reply with quote, forward multi-select
- **Files:** 4 files (MessageActions component, EditMessage, ReplyMessage, ForwardModal)
- **Time:** 75 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 30, 38

### Codex Task 43: Reactions, Search & Offline Queue
- **File:** `CODEX_043_20260212.prompts.md` (to be created)
- **What:** Emoji picker reactions, search screen with highlighting, AsyncStorage offline queue
- **Files:** 5 files (ReactionPicker, SearchScreen, OfflineQueue service, highlight utils, integration)
- **Time:** 60 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 32, 34, 38

---

## ğŸ”— Task Dependencies Map

```
Phase 1 Complete (Authentication & User Management)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Socket.io & Message Infrastructure                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Task 28: Socket.io Infrastructure (JWT auth, presence)        â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 29: Message Model & Schema (Prisma migrations)           â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 30: Message tRPC Procedures (CRUD operations)            â”‚
â”‚     â†“                        â†“                                 â”‚
â”‚ Task 31: Socket.io Events    Task 34: Search & Filtering      â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 32: Reactions System                                     â”‚
â”‚                                                                â”‚
â”‚ Task 33: Media Upload (S3/Cloudinary) â† parallel              â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 35: Offline Queue (Redis) â† depends on 28, 31            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MOBILE: Chat UI & Real-Time Features                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Task 36: Socket.io Client (SocketContext) â† depends on 28     â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 37: Chat List Screen â† depends on 30, 36                 â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 38: Chat Screen (FlatList, bubbles) â† depends on 30,31,36â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 39: Message Input & Sending â† depends on 38              â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 40: Image & Video Sharing â† depends on 33, 39            â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 41: File & Voice Messages â† depends on 33, 39            â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 42: Message Interactions â† depends on 30, 38             â”‚
â”‚     â†“                                                          â”‚
â”‚ Task 43: Reactions, Search, Offline â† depends on 32, 34, 38   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Phase 2 Complete: Real-Time Chat (1-on-1 Messaging)
```

**Parallelizable Tasks:**
- Task 33 (Media Upload) can run parallel with Tasks 30-32
- Tasks 34 (Search) can run parallel with Tasks 31-32
- Some mobile tasks can have UI built parallel to backend (then integrate)

---

## ğŸ“ Execution Workflow

Follow the standard 6-phase workflow for this master prompt:

### Phase 1: DISCOVER âœ…

**Load Required Context:**
- [ ] Read this master prompt (`003_20260204.prompts.md`)
- [ ] Review Phase 1 completion status in `work_reports/01_PROJECT_STATUS.md`
- [ ] Check `work_reports/00_FEATURE_CHECKLIST.md` (Phase 2: 16 features)
- [ ] Review Prisma schema for Message, Conversation, MessageReaction models
- [ ] Verify Docker services running: `docker ps` (PostgreSQL, Redis)
- [ ] Review auth system implementation from Phase 1
- [ ] Check git status (clean working tree)

**Success Criteria:**
- âœ… Phase 1 is 100% complete with all auth features working
- âœ… All dependencies met (database, backend, mobile app, auth)
- âœ… Prisma models for messaging exist in schema
- âœ… No blocking issues
- âœ… Ready to begin Codex task execution

---

### Phase 2: DECOMPOSE âœ…

**This master prompt has pre-decomposed tasks:**
- âœ… 16 Codex tasks identified
- âœ… Backend tasks: 8 tasks (~6.5 hours)
- âœ… Mobile tasks: 8 tasks (~7.5 hours)
- âœ… Each task is atomic (35-90 min, 3-5 files max)
- âœ… Dependencies mapped (see dependency graph above)
- âœ… Quality gates defined in each Codex prompt

**Recommended Execution Order:**
1. **Week 7-8:** Tasks 28-31 (Socket.io + Messages core) - 4 tasks, ~3.5 hours
2. **Week 8-9:** Tasks 32-35 (Reactions, Media, Search, Queue) - 4 tasks, ~3.5 hours
3. **Week 9-10:** Tasks 36-39 (Mobile Socket + Chat screens) - 4 tasks, ~4 hours
4. **Week 10-11:** Tasks 40-42 (Media sharing + Interactions) - 3 tasks, ~3.5 hours
5. **Week 11-12:** Task 43 (Reactions, Search, Offline) - 1 task, ~1 hour
6. **Week 12:** Integration testing, bug fixes, documentation

**Parallelization Opportunities:**
- Task 33 (Media Upload) can be built while Tasks 30-32 are being developed
- Mobile UI mockups (Tasks 37-39) can be designed before backend is ready
- Search (Task 34) can be implemented parallel to reactions (Task 32)

---

### Phase 3: DELEGATE

For each Codex task (execute in order 28-43):

**Step 1:** Create Codex Prompt (if not exists)
```bash
# Check if Codex prompt exists
ls .copilot/prompts/CODEX_0XX_YYYYMMDD.prompts.md

# If not, create using CODEX_README.md template
cat .copilot/prompts/CODEX_README.md
# Follow template to create prompt with:
# - Objective, Context, Implementation Steps
# - Quality Gates (standard + task-specific)
# - Documentation updates (5 files)
# - Rollback plan
```

**Step 2:** Execute via Codex CLI (or manual fallback)
```bash
# Primary: Codex CLI
codex exec --full-auto -C /Volumes/SATECHI_WD_BLACK_2/openchat-expo \
  "$(cat .copilot/prompts/CODEX_0XX_YYYYMMDD.prompts.md)"

# If Codex fails: Manual execution
cat .copilot/prompts/CODEX_0XX_YYYYMMDD.prompts.md
# Follow implementation steps manually
# Run quality gates manually
# Update documentation manually
```

**Step 3:** Wait for completion, capture output

**Step 4:** Mark Codex task status as COMPLETE in its prompt file

---

### Phase 4: VERIFY

**After Each Codex Task:**
- [ ] Run quality gates from Codex prompt
- [ ] `git diff` shows only intended changes
- [ ] Files modified correctly (not more, not less)
- [ ] TypeScript compilation succeeds (`pnpm type-check`)
- [ ] Backend builds: `cd apps/api && pnpm build`
- [ ] Mobile builds: `cd apps/mobile && pnpm build` (if applicable)
- [ ] No unintended side effects
- [ ] Task-specific verification passed

**After Task Groups:**

**After Tasks 28-29 (Socket.io + Schema):**
- [ ] Socket.io server listening: Check console for "Socket.io server listening"
- [ ] Prisma migrations applied: `cd apps/api && npx prisma migrate dev`
- [ ] Message/Conversation models created in database
- [ ] WebSocket gateway compiles without errors
- [ ] Can connect to Socket.io server with auth token

**After Tasks 30-32 (Message CRUD + Reactions):**
- [ ] Message send works: `curl -X POST http://localhost:3000/trpc/message.send`
- [ ] Message history retrieval works (paginated)
- [ ] Message editing updates database
- [ ] Message deletion sets deletedAt timestamp
- [ ] Reactions can be added/removed
- [ ] Socket.io broadcasts message events

**After Tasks 33-35 (Media Upload + Search + Queue):**
- [ ] Image upload to S3/Cloudinary works
- [ ] File validation prevents oversized files
- [ ] Thumbnails generated for images
- [ ] Full-text search returns results
- [ ] Offline queue stores undelivered messages in Redis
- [ ] Messages delivered when user comes online

**After Tasks 36-39 (Mobile Socket + Chat Screens):**
- [ ] Socket.io client connects on mobile
- [ ] Chat list shows conversations with last message
- [ ] Chat screen displays messages correctly
- [ ] Message input sends messages via tRPC
- [ ] Real-time messages appear without refresh
- [ ] Typing indicators show "User is typing..."
- [ ] Scroll-to-bottom button appears when scrolled up

**After Tasks 40-43 (Media Sharing + Interactions + Search):**
- [ ] Image picker opens camera/gallery
- [ ] Image upload shows progress bar
- [ ] Video sharing works with preview
- [ ] File picker allows document selection
- [ ] Voice recording captures audio
- [ ] Voice playback works with waveform
- [ ] Long-press shows message actions menu
- [ ] Edit message shows inline input
- [ ] Delete message shows confirmation
- [ ] Reply message shows quoted text
- [ ] Forward message opens contact selector
- [ ] Emoji picker shows reactions
- [ ] Message search highlights results
- [ ] Offline queue sends messages when reconnected

**Final Phase 2 Verification:**
- [ ] All 16 Codex tasks marked COMPLETE
- [ ] All 16 Phase 2 features functional
- [ ] All quality gates passed
- [ ] No regressions introduced (auth still works)
- [ ] Performance acceptable:
  - [ ] Message send <500ms
  - [ ] Socket.io latency <100ms
  - [ ] Message list scrolling smooth (60fps)
  - [ ] Image upload <5s for 5MB file
- [ ] Security checks:
  - [ ] Socket.io requires authentication
  - [ ] Users can only see their conversations
  - [ ] Message editing only allowed by sender
  - [ ] File uploads validated (type, size)
- [ ] UX checks:
  - [ ] Loading states shown during operations
  - [ ] Error messages user-friendly
  - [ ] Optimistic updates for sent messages
  - [ ] Read receipts update in real-time
- [ ] Documentation updated (5 files)

---

### Phase 5: DOCUMENT

**Update 5 Required Files After EACH Codex Task:**

#### 1. `.copilot/works/codex_work_progress_and_reply.md`
```markdown
## Task XX Complete - [Feature Name]

**Feature:** [Task description]
**Files Modified:** [Count] files
**Quality Gates:** âœ… All passed
**Time:** [Actual] minutes (estimated: [Est] min, [X]% accuracy)
**Issues:** [None or list issues]

### Changes Made:
- [List key changes]
- [Implementation details]
- [Decisions made]

### Verification:
- [Quality gate results]
- [Test results]
- [Manual testing results]

### Next Steps:
- Task [XX+1]: [Next task name]
```

#### 2. `work_reports/01_PROJECT_STATUS.md`
Add entry at top:
```markdown
### [Date] [Time JST] - Task XX: [Feature Name]

**Status:** âœ… Complete  
**Type:** Backend / Mobile  
**Time:** [X] minutes  
**Quality:** [Pass/Fail rate]

**Implemented:**
- [Feature 1]
- [Feature 2]

**Verified:**
- [Test result]
- [Build status]

**Progress:** Phase 2: XX/16 tasks ([X]%)
```

#### 3. `work_reports/00_FEATURE_CHECKLIST.md`
Update task status and feature checkboxes:
```markdown
### Backend Tasks:
- [x] **Task 28:** Socket.io Infrastructure âœ… COMPLETE
- [ ] **Task 29:** Message Model & Schema ğŸ”„ IN PROGRESS
...

### Messaging Features:
| Feature | Spec | Backend | Mobile | Web | Status | Notes | Done |
|---------|------|---------|--------|-----|--------|-------|------|
| Send/receive messages | âœ… | âœ… | âœ… | âœ… | Complete | Socket.io real-time | [x] |
| Message read receipts | âœ… | âœ… | âœ… | âœ… | Complete | Seen/delivered | [x] |
...
```

#### 4. `.copilot/works/codex_metrics.md`
Update metrics after each task:
```markdown
## Phase 2 Task Metrics

| Task | Feature | Est Time | Act Time | Accuracy | Status | Issues |
|------|---------|----------|----------|----------|--------|--------|
| 28 | Socket.io | 60 min | [X] min | [X]% | âœ… | 0 |
| 29 | Message Schema | 45 min | [X] min | [X]% | âœ… | 0 |
...

**Cumulative Metrics:**
- Tasks Complete: XX/16
- Average Time Accuracy: [X]%
- Success Rate: [X]%
- Total Time: [X] hours (estimated: 14 hours)
```

#### 5. `CHANGELOG.md`
Add entry for each task (or group of related tasks):
```markdown
## [0.3.0-alpha.X] - [Date]

### Added - Task XX: [Feature Name]

**Backend:**
- [Backend change 1]
- [Backend change 2]

**Mobile:**
- [Mobile change 1]
- [Mobile change 2]

### Changed
- [Any modifications to existing features]

### Fixed
- [Any bug fixes]

### Verified
- [Test results]
- [Quality gate results]
```

**At Phase 2 Completion:**
Update CHANGELOG with comprehensive Phase 2 summary:
```markdown
## [0.3.0] - [Date]

### Added - Phase 2 Complete: Real-Time Chat (1-on-1 Messaging)

**Backend:**
- Socket.io WebSocket gateway with JWT authentication
- Message CRUD operations (send, edit, delete, search)
- Real-time events (message:sent, message:read, typing indicators)
- Message reactions system with emoji support
- Media upload service (S3/Cloudinary) with validation
- Full-text message search with PostgreSQL FTS
- Offline message queue with Redis
- User presence tracking (online/offline status)
- Message delivery tracking and retry logic

**Mobile:**
- Socket.io client with reconnection handling
- Chat list screen with unread badges
- Chat screen with FlatList virtualization
- Message bubbles (sent/received styling)
- Text message input with emoji picker
- Image sharing (camera/gallery via expo-image-picker)
- Video sharing with upload progress
- File sharing (expo-document-picker)
- Voice messages (expo-av recording/playback)
- Message actions (edit, delete, reply, forward)
- Message reactions with emoji picker
- Message search with result highlighting
- Offline message queue with AsyncStorage
- Typing indicators display
- Read receipts (checkmarks)
- Scroll-to-bottom button

**Infrastructure:**
- Prisma migrations for Message, Conversation, MessageReaction models
- S3/Cloudinary bucket configuration
- Redis pub/sub for real-time events
- WebSocket CORS configuration for Expo dev

### Verified
- All 16 Codex tasks complete
- 16/16 Phase 2 features operational
- Real-time messaging working with <100ms latency
- Media uploads successful (images, videos, files, voice)
- Message search finding results accurately
- Offline queue delivering messages on reconnect
- Socket.io handling 100+ concurrent connections
- Performance benchmarks met (60fps scrolling, <500ms send)

### Phase
- Phase 2: Real-Time Chat (1-on-1 Messaging) (Week 7-12 of 20) - COMPLETE âœ…
- Ready for Phase 3: Contacts & Friend Management

### Breaking Changes
- None

### Migration Notes
- Run `cd apps/api && npx prisma migrate dev` to apply messaging migrations
- Configure S3_BUCKET_NAME, S3_ACCESS_KEY, S3_SECRET_KEY in apps/api/.env
- Or configure CLOUDINARY_CLOUD_NAME, CLOUDINARY_API_KEY, CLOUDINARY_API_SECRET
- Ensure Redis is running for Socket.io adapter: `docker-compose up -d redis`
```

---

### Phase 6: CHECKPOINT

**After Each Task:**
- [ ] Commit changes with conventional commit message
- [ ] Push to GitHub: `git push origin main`
- [ ] Verify CI/CD passes (GitHub Actions)
- [ ] Update task status in this master prompt

**After Every 4 Tasks (Weekly Checkpoints):**
- [ ] Review all changes: `git diff origin/main~4 origin/main`
- [ ] Review commit history: `git log --oneline -4`
- [ ] Verify working tree clean: `git status`
- [ ] Run full test suite (if available)
- [ ] Manual testing of new features
- [ ] Update project status documentation

**Final Phase 2 Checkpoint:**
- [ ] Review all 16 task commits
- [ ] Verify all Phase 2 features working
- [ ] All 5 documentation files updated comprehensively
- [ ] Update this master prompt status to COMPLETE
- [ ] Create Phase 2 completion report (optional)
- [ ] Move to next master prompt: `004_[Date].prompts.md` (Phase 3: Contacts)

**Commit Message Template for Tasks:**
```
feat(messaging): [Task XX] - [Feature Name]

ADDED:
- [Key addition 1]
- [Key addition 2]

CHANGED:
- [Modification 1]

VERIFIED:
- [Quality gate passed]
- [Test result]

Task: XX/16
Time: [Actual] min (est: [Est] min, [X]% accuracy)
Phase: Phase 2 - Real-Time Chat ([X]% complete)
```

**Final Commit Message for Phase 2:**
```
âœ¨ feat(phase-2): Complete Real-Time Chat (1-on-1 Messaging)

ADDED:
Backend:
- Socket.io WebSocket gateway with JWT auth
- Message CRUD operations (send, edit, delete, search)
- Real-time events (sent, read, typing)
- Message reactions with emoji
- Media upload service (S3/Cloudinary)
- Full-text search (PostgreSQL FTS)
- Offline message queue (Redis)
- User presence tracking

Mobile:
- Socket.io client with reconnection
- Chat list with unread badges
- Chat screen with virtualized message list
- Message input with emoji picker
- Image/video/file/voice sharing
- Message actions (edit, delete, reply, forward)
- Reactions, search, offline queue
- Typing indicators, read receipts

Infrastructure:
- Prisma migrations (Message, Conversation, MessageReaction)
- S3/Cloudinary bucket config
- Redis pub/sub for Socket.io
- WebSocket CORS for Expo

VERIFIED:
- All 16 Codex tasks complete (100%)
- 16/16 Phase 2 features working
- Real-time latency <100ms
- Media uploads successful
- Search accurate, offline queue working
- Performance: 60fps scroll, <500ms send
- Socket.io: 100+ concurrent connections

CODEX TASKS: 16/16 complete
TIME: [Actual] hours (estimated: 14 hours, [X]% accuracy)
PHASE: Phase 2 - Real-Time Chat (1-on-1 Messaging) COMPLETE âœ…
NEXT: Phase 3 - Contacts & Friend Management
```

---

## ğŸ¯ Success Criteria

Phase 2 is complete when:

### Functional Requirements:
- [ ] All 16 Codex tasks executed successfully
- [ ] All 16 Phase 2 features operational (see checklist below)
- [ ] Socket.io server and client communicating
- [ ] Real-time message sending/receiving works
- [ ] Message persistence in PostgreSQL
- [ ] Read receipts tracking accurately
- [ ] Typing indicators show in real-time
- [ ] Message reactions display correctly
- [ ] Message editing updates with history
- [ ] Message deletion shows placeholder
- [ ] Message forwarding to multiple users
- [ ] Message replies show quoted text
- [ ] User mentions trigger notifications
- [ ] Message pinning to chat header
- [ ] Full-text search returns results
- [ ] Image sharing via camera/gallery
- [ ] Video uploads with progress
- [ ] File sharing works (any file type)
- [ ] Voice messages record and play
- [ ] Offline queue delivers messages on reconnect

### Technical Requirements:
- [ ] TypeScript compiles with zero errors
- [ ] Backend builds successfully
- [ ] Mobile app builds for iOS and Android
- [ ] All Prisma migrations applied
- [ ] Database models match schema
- [ ] tRPC procedures accessible from mobile
- [ ] Socket.io events broadcasted correctly
- [ ] Media files stored in S3/Cloudinary
- [ ] Redis storing presence and queue data

### Performance Requirements:
- [ ] Message send latency <500ms
- [ ] Socket.io latency <100ms
- [ ] Message list scrolling smooth (60fps)
- [ ] Image upload <5s for 5MB file
- [ ] Search results returned <1s
- [ ] Socket.io handles 100+ concurrent users
- [ ] Database queries <100ms (indexed)

### Security Requirements:
- [ ] Socket.io requires JWT authentication
- [ ] Users can only access their conversations
- [ ] Message editing only by original sender
- [ ] Message deletion only by sender
- [ ] File upload validation (type, size, virus scan ready)
- [ ] SQL injection prevented (Prisma ORM)
- [ ] XSS prevention in message content
- [ ] CSRF tokens for file uploads

### UX Requirements:
- [ ] Loading states during async operations
- [ ] Error messages user-friendly
- [ ] Optimistic updates for sent messages
- [ ] Read receipts update without reload
- [ ] Typing indicators debounced (stops after 2s)
- [ ] Image previews before sending
- [ ] Video thumbnails in message list
- [ ] Voice message waveform display
- [ ] Scroll-to-bottom when new message arrives
- [ ] Unread badge counts accurate

### Documentation Requirements:
- [ ] All 5 required files updated
- [ ] README.md updated with Phase 2 features
- [ ] API documentation for new tRPC procedures
- [ ] Socket.io event documentation
- [ ] Media upload API documented
- [ ] Environment variables documented

### Quality Gates (Same as Phase 1):
- [ ] `pnpm type-check` passes (backend + mobile)
- [ ] `pnpm build` succeeds (backend + mobile)
- [ ] Git diff shows only intended changes
- [ ] Commit messages follow conventional commits
- [ ] No console errors in development
- [ ] No TypeScript `any` types (use proper typing)

---

## ğŸ§ª Testing Strategy

### Unit Tests (per task):
- Message service methods (send, edit, delete)
- Reaction service methods (add, remove)
- Upload service validation (file type, size)
- Search service query building

### Integration Tests (after task groups):
- Socket.io connection with JWT auth
- Message CRUD via tRPC procedures
- Real-time event broadcasting
- Media upload end-to-end
- Message search with various filters
- Offline queue delivery

### End-to-End Tests (final verification):
1. **Basic Messaging Flow:**
   - User A sends message to User B
   - User B receives message in real-time
   - User B reads message (read receipt updates)
   - User A sees "Seen" status

2. **Media Sharing Flow:**
   - User A uploads image from gallery
   - Progress bar shows during upload
   - Image appears in chat with thumbnail
   - User B can download and view full image

3. **Message Interactions Flow:**
   - User A sends message
   - User B long-presses message
   - User B selects "Reply"
   - Reply shows quoted original
   - User A receives reply with quote

4. **Offline Flow:**
   - User A goes offline (disable WiFi)
   - User A sends message (queued)
   - User A reconnects (WiFi enabled)
   - Message delivered automatically

5. **Voice Message Flow:**
   - User A presses record button
   - Records 10s audio
   - Waveform shows during recording
   - User A sends voice message
   - User B can play with waveform

### Performance Tests:
- Send 100 messages and measure average latency
- Scroll through 1000 messages and check FPS
- Upload 10 images simultaneously
- Search 10,000 messages for keyword

---

## ğŸš¨ Rollback Plan

**If Critical Issues Arise:**

### Per-Task Rollback:
```bash
# Identify last good commit
git log --oneline -10

# Revert specific commit
git revert [commit-hash]

# Or hard reset to previous commit (use with caution)
git reset --hard [commit-hash]

# Restore database to previous migration
cd apps/api
npx prisma migrate rollback
```

### Per-Feature Rollback:
1. Identify commits related to feature
2. Create revert commits in reverse order
3. Update documentation to mark feature as reverted
4. Create GitHub issue for the bug
5. Continue with next task

### Emergency Full Rollback:
```bash
# Return to Phase 1 complete state
git checkout [phase-1-complete-commit-hash]
git checkout -b phase-2-retry
git push origin phase-2-retry

# Drop Phase 2 migrations
cd apps/api
npx prisma migrate reset
npx prisma migrate deploy # Apply only Phase 1 migrations

# Restore Redis (if needed)
docker-compose down redis
docker volume rm openchat-expo_redis-data
docker-compose up -d redis
```

---

## ğŸ“š Key Technical References

### Socket.io:
- **Docs:** https://socket.io/docs/v4/
- **Authentication:** https://socket.io/docs/v4/middlewares/
- **NestJS Integration:** https://docs.nestjs.com/websockets/gateways
- **Redis Adapter:** https://socket.io/docs/v4/redis-adapter/

### Prisma:
- **Full-Text Search:** https://www.prisma.io/docs/concepts/components/prisma-client/full-text-search
- **Pagination:** https://www.prisma.io/docs/concepts/components/prisma-client/pagination
- **Transactions:** https://www.prisma.io/docs/concepts/components/prisma-client/transactions

### Expo:
- **Image Picker:** https://docs.expo.dev/versions/latest/sdk/imagepicker/
- **Document Picker:** https://docs.expo.dev/versions/latest/sdk/document-picker/
- **AV (Audio/Video):** https://docs.expo.dev/versions/latest/sdk/av/
- **AsyncStorage:** https://docs.expo.dev/versions/latest/sdk/async-storage/

### Media Upload:
- **AWS S3 SDK:** https://docs.aws.amazon.com/sdk-for-javascript/v3/developer-guide/
- **Cloudinary Node:** https://cloudinary.com/documentation/node_integration

---

## ğŸ“Š Estimated Timeline

**Total Duration:** 5-6 weeks (35-42 days)

### Week 7 (Feb 11-17):
- Tasks 28-29: Socket.io + Message Schema (~2 hours)
- Start Task 30: Message CRUD

### Week 8 (Feb 18-24):
- Complete Task 30: Message CRUD
- Tasks 31-32: Real-time Events + Reactions (~1.5 hours)
- Start Task 33: Media Upload

### Week 9 (Feb 25-Mar 3):
- Complete Task 33: Media Upload
- Tasks 34-35: Search + Offline Queue (~2 hours)
- Start Task 36: Socket.io Client (Mobile)

### Week 10 (Mar 4-10):
- Complete Task 36: Socket.io Client
- Tasks 37-38: Chat List + Chat Screen (~2.5 hours)
- Start Task 39: Message Input

### Week 11 (Mar 11-17):
- Complete Task 39: Message Input
- Tasks 40-41: Image/Video + Files/Voice (~2.5 hours)
- Start Task 42: Message Interactions

### Week 12 (Mar 18-24):
- Complete Task 42: Message Interactions
- Task 43: Reactions, Search, Offline (~1 hour)
- Integration testing
- Bug fixes
- Documentation finalization

**Buffer:** 1 week for unexpected issues, refactoring, polish

---

## ğŸ“ Lessons from Phase 1

**Apply These Learnings:**
1. âœ… **Perfect Time Estimates:** Phase 1 had 100% accuracy (7/7 tasks) - maintain this!
2. âœ… **Systematic Workflow:** 6-phase approach worked flawlessly
3. âœ… **Quality Gates:** Caught issues early, prevented regressions
4. âœ… **Documentation Discipline:** 5-file updates kept project organized
5. âœ… **Git Hygiene:** Clean commits with detailed messages
6. âœ… **Atomic Tasks:** 30-90 min tasks are the sweet spot
7. âœ… **Dependencies Clear:** Dependency graph prevented blocking

**New Challenges in Phase 2:**
1. âš ï¸ **Real-Time Complexity:** Socket.io adds asynchronous complexity
2. âš ï¸ **Media Handling:** Large file uploads need careful testing
3. âš ï¸ **Performance Critical:** Message list must scroll smoothly
4. âš ï¸ **Offline Sync:** Queue logic must be bulletproof
5. âš ï¸ **Cross-Device:** Test on iOS + Android + Web

**Mitigation Strategies:**
- Add Socket.io connection monitoring
- Implement upload progress and error handling
- Use FlatList virtualization for performance
- Add comprehensive offline queue tests
- Test on all target platforms early

---

## ğŸ“ Notes

- **Expo SDK 54** supports all required media APIs
- **NestJS 11** has excellent Socket.io integration
- **PostgreSQL 15** has full-text search built-in
- **Redis 7** is used for Socket.io adapter and offline queue
- **S3 or Cloudinary** - choose based on preference (both work)
- **tRPC 11.9** handles both HTTP and WebSocket seamlessly

**Important Decisions:**
- **Media Storage:** Recommend S3 for cost, Cloudinary for ease
- **Search:** PostgreSQL FTS sufficient for now (can add Elasticsearch later)
- **Real-Time:** Socket.io chosen over native WebSocket for better reliability
- **Message Queue:** Redis for simplicity (can move to RabbitMQ later if needed)

---

## âœ… Master Prompt Status

- [x] Created: 2026-02-04 19:52 JST
- [ ] In Progress: [Date]
- [ ] Complete: [Date]
- [ ] Verified: [Date]
- [ ] Documented: [Date]

**Created By:** Human Orchestrator  
**Assigned To:** Master Copilot Agent  
**Priority:** High (Critical Path)  
**Dependencies:** Phase 1 complete âœ…

---

**END OF MASTER PROMPT 003**
