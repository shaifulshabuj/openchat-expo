# Master Prompt 002: Phase 1 - Authentication & User Management

**Date:** 2026-02-04 16:20 JST  
**Phase:** Phase 1 - Authentication & User Management (Week 3-6 of 20)  
**Type:** Phase  
**Estimated Duration:** 4 weeks  
**Codex Tasks:** 15 atomic tasks

---

## üéØ Objective

Implement a complete authentication and user management system for OpenChat Expo, enabling users to register, login, manage their profiles, and securely store authentication tokens. This phase establishes the security foundation for all future features and enables basic user identity management across iOS, Android, and Web platforms.

Upon completion, users will be able to:
- Register new accounts with email verification
- Login/logout securely with JWT authentication
- Reset forgotten passwords via email
- Update profile information (avatar, username, bio, status)
- Use biometric authentication (Touch ID/Face ID) on mobile
- Have secure token storage using expo-secure-store
- Manage online/offline/away status

---

## üìã Context

### Current State:
- ‚úÖ Phase 0.B complete (Project Scaffolding - 100%)
- ‚úÖ Expo mobile app running with tabs template
- ‚úÖ NestJS backend with tRPC configured
- ‚úÖ Prisma schema with 14 models (including User, Session)
- ‚úÖ Shared packages (@openchat/types, @openchat/config)
- ‚úÖ Docker Compose with PostgreSQL + Redis
- ‚úÖ No authentication implemented yet
- ‚úÖ No database migrations run yet

### Desired State:
- ‚úÖ JWT authentication working (access + refresh tokens)
- ‚úÖ Password hashing with bcrypt
- ‚úÖ Email verification system operational
- ‚úÖ Password reset flow functional
- ‚úÖ Login/Register screens in mobile app
- ‚úÖ Profile management screens
- ‚úÖ Biometric authentication on mobile
- ‚úÖ Secure token storage
- ‚úÖ Session management with Redis
- ‚úÖ User status (online/offline/away/busy)
- ‚úÖ Database migrations applied
- ‚úÖ Authentication middleware for protected routes
- ‚úÖ All 8 Phase 1 features complete

### Why This Master Prompt:
- **Foundation:** All future features require user authentication
- **Security:** Establishes secure patterns for entire application
- **Blocking:** Messaging, contacts, groups all depend on auth
- **Critical Path:** Must complete before Phase 2 (Messaging)
- **User Experience:** First interaction users have with app
- **Compliance:** Proper password handling and data security

---

## üß© Task Decomposition

This master prompt breaks down into 15 Codex tasks:

### Codex Task 13: Environment Configuration & Database Setup
- **File:** `CODEX_013_20260204.prompts.md` (to be created)
- **What:** Create .env.example files, run Prisma migrations
- **Files:** 3 files (apps/api/.env.example, apps/mobile/.env.example, migrations/)
- **Time:** 20 minutes
- **Status:** NOT STARTED
- **Dependencies:** None (Phase 0.B complete)

### Codex Task 14: JWT Authentication Module (Backend)
- **File:** `CODEX_014_20260205.prompts.md` (to be created)
- **What:** Create auth module with JWT strategy, guards, decorators
- **Files:** 5 files (auth.module.ts, jwt.strategy.ts, auth.guard.ts, etc.)
- **Time:** 45 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 13

### Codex Task 15: Password Hashing Service
- **File:** `CODEX_015_20260205.prompts.md` (to be created)
- **What:** Implement bcrypt password hashing and validation
- **Files:** 2 files (password.service.ts, password.service.spec.ts)
- **Time:** 20 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 14

### Codex Task 16: User Registration tRPC Procedure
- **File:** `CODEX_016_20260206.prompts.md` (to be created)
- **What:** Create register procedure with validation (email, username, password)
- **Files:** 3 files (auth.router.ts, register.dto.ts, tests)
- **Time:** 30 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 14, 15

### Codex Task 17: User Login tRPC Procedure
- **File:** `CODEX_017_20260206.prompts.md` (to be created)
- **What:** Create login procedure returning JWT tokens
- **Files:** 2 files (auth.router.ts update, login.dto.ts)
- **Time:** 25 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 14, 15, 16

### Codex Task 18: Email Verification System
- **File:** `CODEX_018_20260207.prompts.md` (to be created)
- **What:** Implement email verification with tokens (nodemailer setup)
- **Files:** 4 files (email.service.ts, verify email procedures, templates)
- **Time:** 40 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 16

### Codex Task 19: Password Reset Flow
- **File:** `CODEX_019_20260207.prompts.md` (to be created)
- **What:** Create password reset request and confirm procedures
- **Files:** 3 files (reset password procedures, email templates)
- **Time:** 35 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 18

### Codex Task 20: Session Management with Redis
- **File:** `CODEX_020_20260208.prompts.md` (to be created)
- **What:** Implement session storage in Redis with refresh tokens
- **Files:** 3 files (session.service.ts, redis.module.ts, session management)
- **Time:** 30 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 14

### Codex Task 21: Profile Management tRPC Procedures
- **File:** `CODEX_021_20260208.prompts.md` (to be created)
- **What:** Create get/update profile procedures (avatar, bio, username, status)
- **Files:** 4 files (profile.router.ts, update profile DTOs, validation)
- **Time:** 35 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 14

### Codex Task 22: Auth Context & Token Storage (Mobile)
- **File:** `CODEX_022_20260209.prompts.md` (to be created)
- **What:** Create React Context for auth state, expo-secure-store integration
- **Files:** 3 files (AuthContext.tsx, tokenStorage.ts, useAuth hook)
- **Time:** 30 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 17, 20

### Codex Task 23: Register Screen (Mobile)
- **File:** `CODEX_023_20260209.prompts.md` (to be created)
- **What:** Build registration UI with NativeBase (email, username, password, confirm)
- **Files:** 2 files (register.tsx, validation logic)
- **Time:** 45 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 16, 22

### Codex Task 24: Login Screen (Mobile)
- **File:** `CODEX_024_20260210.prompts.md` (to be created)
- **What:** Build login UI with NativeBase (email/username, password, remember me)
- **Files:** 2 files (login.tsx, login logic)
- **Time:** 40 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 17, 22

### Codex Task 25: Profile Screen (Mobile)
- **File:** `CODEX_025_20260210.prompts.md` (to be created)
- **What:** Build profile view/edit UI (avatar picker, bio, username, status)
- **Files:** 3 files (profile.tsx, edit profile modal, image picker)
- **Time:** 50 minutes
- **Status:** NOT STARTED
- **Dependencies:** Tasks 21, 22

### Codex Task 26: Biometric Authentication (Mobile)
- **File:** `CODEX_026_20260211.prompts.md` (to be created)
- **What:** Implement Touch ID/Face ID using expo-local-authentication
- **Files:** 2 files (biometric.service.ts, biometric toggle in settings)
- **Time:** 30 minutes
- **Status:** NOT STARTED
- **Dependencies:** Task 22

### Codex Task 27: Protected Routes & Auth Flow Testing
- **File:** `CODEX_027_20260211.prompts.md` (to be created)
- **What:** Setup route protection, test full auth flow, add loading states
- **Files:** 3 files (ProtectedRoute component, navigation guards, integration tests)
- **Time:** 35 minutes
- **Status:** NOT STARTED
- **Dependencies:** All previous tasks (22-26)

---

**Total Codex Tasks:** 15  
**Total Estimated Time:** 8 hours 30 minutes (distributed over 4 weeks)

---

## üîÑ Execution Workflow

### Phase 1: DISCOVER ‚úÖ

**Actions:**
- [ ] Read `.copilot/works/codex_next_priorities.md` (confirm Phase 1 next)
- [ ] Read `work_reports/01_PROJECT_STATUS.md` (Phase 0.B complete)
- [ ] Check git status (clean working tree)
- [ ] Review Phase 1 features in `work_reports/00_FEATURE_CHECKLIST.md` (8 features)
- [ ] Verify Prisma User model has all needed fields
- [ ] Confirm Docker PostgreSQL and Redis running

**Success Criteria:**
- ‚úÖ Phase 0.B is 100% complete
- ‚úÖ All dependencies met (database, backend, mobile app)
- ‚úÖ No blocking issues
- ‚úÖ Ready to begin Codex task execution

---

### Phase 2: DECOMPOSE ‚úÖ

**This master prompt has pre-decomposed tasks:**
- ‚úÖ 15 Codex tasks identified
- ‚úÖ Each task is atomic (20-50 min, 2-5 files max)
- ‚úÖ Dependencies mapped (Tasks 13-27 sequential with some parallelizable)
- ‚úÖ Quality gates defined in each Codex prompt

**Task Dependencies:**
```
Task 13 (Env + DB migrations)
    ‚Üì
Task 14 (JWT Auth Module) ‚Üê foundation for all auth
    ‚Üì
Task 15 (Password Hashing) ‚Üê depends on Task 14
    ‚Üì
Task 16 (Register) ‚Üê depends on Tasks 14, 15
Task 17 (Login) ‚Üê depends on Tasks 14, 15, 16
    ‚Üì
Task 18 (Email Verification) ‚Üê depends on Task 16
Task 19 (Password Reset) ‚Üê depends on Task 18
Task 20 (Session Management) ‚Üê depends on Task 14
Task 21 (Profile Management) ‚Üê depends on Task 14
    ‚Üì
Task 22 (Auth Context Mobile) ‚Üê depends on Tasks 17, 20
    ‚Üì
Task 23 (Register Screen) ‚Üê depends on Tasks 16, 22
Task 24 (Login Screen) ‚Üê depends on Tasks 17, 22
Task 25 (Profile Screen) ‚Üê depends on Tasks 21, 22
Task 26 (Biometric Auth) ‚Üê depends on Task 22
    ‚Üì
Task 27 (Route Protection + Testing) ‚Üê depends on Tasks 22-26
```

---

### Phase 3: DELEGATE

For each Codex task (execute in order 13-27):

**Step 1:** Create Codex Prompt (if not exists)
```bash
# Check if Codex prompt exists
ls .copilot/prompts/CODEX_0XX_YYYYMMDD.prompts.md

# If not, create using CODEX_README.md template
cat .copilot/prompts/CODEX_README.md
# Follow template to create prompt with:
# - Objective, Context, Implementation Steps
# - Quality Gates (standard + task-specific)
# - Documentation updates (5 files)
# - Rollback plan
```

**Step 2:** Execute via Codex CLI (or manual fallback)
```bash
# Primary: Codex CLI
codex exec --full-auto -C /Volumes/SATECHI_WD_BLACK_2/openchat-expo \
  "$(cat .copilot/prompts/CODEX_0XX_YYYYMMDD.prompts.md)"

# If Codex fails: Manual execution
cat .copilot/prompts/CODEX_0XX_YYYYMMDD.prompts.md
# Follow implementation steps manually
# Run quality gates manually
# Update documentation manually
```

**Step 3:** Wait for completion, capture output

**Step 4:** Mark Codex task status as COMPLETE in its prompt file

---

### Phase 4: VERIFY

**After Each Codex Task:**
- [ ] Run quality gates from Codex prompt
- [ ] `git diff` shows only intended changes
- [ ] Files modified correctly (not more, not less)
- [ ] TypeScript compilation succeeds (`pnpm type-check`)
- [ ] No unintended side effects
- [ ] Task-specific verification passed

**After Task Groups:**

**After Tasks 13-15 (Auth Foundation):**
- [ ] Prisma migrations applied: `cd apps/api && npx prisma migrate dev`
- [ ] JWT module compiles without errors
- [ ] Password hashing tests pass
- [ ] .env files created with examples

**After Tasks 16-21 (Backend Auth Procedures):**
- [ ] Register procedure works: `curl -X POST http://localhost:3000/trpc/auth.register`
- [ ] Login returns JWT tokens
- [ ] Email verification sends emails (check logs)
- [ ] Password reset flow functional
- [ ] Session stored in Redis: `redis-cli KEYS "session:*"`
- [ ] Profile update works

**After Tasks 22-26 (Mobile Auth UI):**
- [ ] Auth context provides login/logout/register
- [ ] Register screen validates input
- [ ] Login screen authenticates users
- [ ] Profile screen shows/edits user data
- [ ] Biometric auth prompts appear
- [ ] Tokens stored securely

**After Task 27 (Integration):**
- [ ] Protected routes redirect to login
- [ ] Full auth flow works end-to-end:
  1. Register ‚Üí Email verification ‚Üí Login
  2. Login ‚Üí Access protected route ‚Üí Logout
  3. Password reset ‚Üí Receive email ‚Üí Reset ‚Üí Login
- [ ] Biometric login works on physical device
- [ ] Token refresh works automatically
- [ ] Session persists across app restarts

**Final Phase 1 Verification:**
- [ ] All 15 Codex tasks marked COMPLETE
- [ ] All 8 Phase 1 features functional
- [ ] All quality gates passed
- [ ] No regressions introduced
- [ ] Performance acceptable (<300ms API response)
- [ ] Security best practices followed (no passwords in logs, tokens encrypted)
- [ ] Documentation updated (5 files)

---

### Phase 5: DOCUMENT

**Update 5 Required Files:**

#### 1. `.copilot/works/codex_work_progress_and_reply.md`
```markdown
## Master Prompt 002 Complete - Phase 1 Done

**Feature:** Phase 1 - Authentication & User Management
**Date:** [Completion date] JST
**Codex Tasks:** 15/15 complete
**Time:** [Actual time] (estimated: 8h 30min)
**Issues:** [Any issues encountered]

**What Was Accomplished:**
- JWT authentication with access + refresh tokens
- Password hashing with bcrypt
- Email verification system
- Password reset flow
- Profile management (avatar, bio, username, status)
- Session management with Redis
- Mobile auth screens (register, login, profile)
- Biometric authentication (Touch ID/Face ID)
- Secure token storage with expo-secure-store
- Protected routes with auth guards

**Verification:**
- All 15 Codex tasks complete ‚úÖ
- All quality gates passed ‚úÖ
- Full auth flow tested ‚úÖ
- 8/8 Phase 1 features operational ‚úÖ
```

#### 2. `work_reports/01_PROJECT_STATUS.md`
```markdown
## ‚úÖ Latest Progress ([Date] JST) - **PHASE 1 COMPLETE** üéâ

- üéØ **Phase 1:** Authentication & User Management 100% complete (15/15 tasks)
- üîê **Backend Auth:** JWT, password hashing, email verification, sessions
- üì± **Mobile Auth:** Register, login, profile screens with biometric support
- üîí **Security:** Secure token storage, protected routes, refresh tokens
- üìß **Email:** Verification and password reset flows operational
- ‚è±Ô∏è **Timeline:** On track (Week 6 of 20 complete)

**Ready for Phase 2:** Real-Time Chat (1-on-1 Messaging)
```

#### 3. `work_reports/00_FEATURE_CHECKLIST.md`
```markdown
## üéØ **PHASE 1: AUTHENTICATION & USER MANAGEMENT - ‚úÖ 100% COMPLETE**

| Feature | Spec | Backend | Mobile | Web | Status | Notes | Done |
|---------|------|---------|--------|-----|--------|-------|------|
| User registration | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Complete | Email validation working | [x] |
| User login/logout | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Complete | JWT tokens secure | [x] |
| Password reset | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Complete | Email flow functional | [x] |
| Email verification | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Complete | Verification links sent | [x] |
| Profile management | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Complete | Avatar, username, bio, status | [x] |
| Status management | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Complete | Online/offline/away/busy | [x] |
| Biometric authentication | ‚úÖ | N/A | ‚úÖ | N/A | Complete | Touch ID/Face ID working | [x] |
| Secure token storage | ‚úÖ | N/A | ‚úÖ | ‚úÖ | Complete | expo-secure-store integrated | [x] |
```

#### 4. `.copilot/works/codex_metrics.md`
```markdown
## Master Prompt 002 Metrics

**Phase:** Phase 1 - Authentication & User Management
**Codex Tasks:** 15
**Estimated Time:** 8h 30min (510 min)
**Actual Time:** [Actual time]
**Accuracy:** [Percentage]
**Success Rate:** [X/15 tasks complete]
**Quality Gates:** [Pass rate]
**Issues:** [Count]
**Rollbacks:** [Count]

**Task Breakdown:**
- Backend tasks (9): Average [X] min (est 30 min avg)
- Mobile tasks (5): Average [X] min (est 40 min avg)
- Integration task (1): [X] min (est 35 min)

**Lessons Learned:**
- [Key insights from Phase 1]
- [Challenges overcome]
- [Best practices identified]
```

#### 5. `CHANGELOG.md`
```markdown
## [0.2.0] - [Date]

### Added - Phase 1 Complete: Authentication & User Management

**Backend:**
- JWT authentication with access and refresh tokens
- Password hashing using bcrypt with salt rounds
- Email verification system with nodemailer
- Password reset flow with secure tokens
- Session management using Redis
- Profile management endpoints (get/update profile)
- Auth guards and decorators for protected routes
- User status management (online/offline/away/busy)

**Mobile:**
- Authentication context with useAuth hook
- Secure token storage using expo-secure-store
- Register screen with validation (email, username, password)
- Login screen with remember me functionality
- Profile screen with avatar picker and bio editor
- Biometric authentication (Touch ID/Face ID)
- Protected route components
- Loading states and error handling

**Infrastructure:**
- Prisma migrations applied (User, Session models)
- Redis session store configured
- Email service with SMTP configuration
- Environment variables documented in .env.example

### Verified
- All 15 Codex tasks complete
- 8/8 Phase 1 features operational
- Full authentication flow tested
- Biometric authentication working on device
- Token refresh automatic
- Session persistence across app restarts
- Security best practices followed

### Phase
- Phase 1: Authentication & User Management (Week 3-6 of 20) - COMPLETE ‚úÖ
- Ready for Phase 2: Real-Time Chat (1-on-1 Messaging)

### Breaking Changes
- None

### Migration Notes
- Run `cd apps/api && npx prisma migrate dev` to apply auth migrations
- Configure SMTP credentials in apps/api/.env for email functionality
- Update JWT_SECRET and REFRESH_TOKEN_SECRET in production
```

---

### Phase 6: CHECKPOINT

**Actions:**
- [ ] Review all changes: `git diff`
- [ ] Review commit history: `git log --oneline --since="4 weeks ago"`
- [ ] Verify working tree clean: `git status`
- [ ] All 5 documentation files updated: ‚úÖ
- [ ] Update master prompt status to COMPLETE
- [ ] Move to next master prompt: `003_[Date].prompts.md` (Phase 2: Messaging)

**Commit Message:**
```
‚ú® feat(phase-1): Complete Authentication & User Management

ADDED:
Backend:
- JWT authentication (access + refresh tokens)
- Password hashing with bcrypt
- Email verification system (nodemailer)
- Password reset flow
- Session management (Redis)
- Profile management endpoints
- Auth guards and protected routes
- User status management

Mobile:
- Authentication context (useAuth)
- Secure token storage (expo-secure-store)
- Register screen with validation
- Login screen with biometric option
- Profile screen (avatar, bio, username, status)
- Biometric authentication (Touch ID/Face ID)
- Protected route components
- Loading states and error handling

Infrastructure:
- Prisma migrations applied
- Redis session store
- SMTP email service
- .env.example files

VERIFIED:
- All 15 Codex tasks complete
- 8/8 Phase 1 features working
- Full auth flow tested (register ‚Üí verify ‚Üí login ‚Üí logout)
- Biometric auth tested on device
- Token refresh automatic
- Session persists across restarts
- Security best practices followed (no passwords in logs)

CODEX TASKS: 15/15 complete
TIME: [Actual] (estimated: 8h 30min, [X]% accuracy)
PHASE: Phase 1 - Authentication & User Management COMPLETE ‚úÖ
NEXT: Phase 2 - Real-Time Chat (1-on-1 Messaging)
```

---

## üéØ Success Criteria

Phase 1 is complete when:
- [ ] All 15 Codex tasks executed successfully
- [ ] All 8 Phase 1 features operational
- [ ] JWT authentication working (access + refresh)
- [ ] Password hashing secure (bcrypt, salt rounds)
- [ ] Email verification sends and validates links
- [ ] Password reset flow functional
- [ ] Profile management works (avatar, bio, username, status)
- [ ] Session management with Redis operational
- [ ] Mobile register/login/profile screens functional
- [ ] Biometric authentication works on device
- [ ] Secure token storage implemented
- [ ] Protected routes enforce authentication
- [ ] Full auth flow tested end-to-end
- [ ] All 5 documentation files updated
- [ ] Changes committed and pushed
- [ ] Master prompt marked COMPLETE
- [ ] Ready for Phase 2 (Messaging)

---

## üö® Rollback Plan

If Phase 1 fails completely:

### Nuclear Option:
```bash
cd /Volumes/SATECHI_WD_BLACK_2/openchat-expo
git log --oneline | grep "phase-1"
git revert [commit-hash]
# Or reset to Phase 0.B complete:
git reset --hard 489f7c4
pnpm install
cd apps/api && npx prisma migrate reset
```

### Partial Rollback (by Codex task):
Each Codex prompt has its own rollback plan. Use those for targeted recovery.

### Resume After Rollback:
1. Identify which Codex task failed
2. Fix the issue causing failure
3. Update Codex prompt if needed
4. Re-execute from failed task forward
5. Verify all quality gates
6. Continue to completion

---

## üìä Estimated Impact

**Lines of Code:** ~2,500 (backend + mobile)  
**Files Created:** ~30  
**Files Modified:** ~10  
**Breaking Changes:** None  
**Migration Progress:** 10/77 features complete (13%)  
**Security Level:** High (JWT, bcrypt, secure storage)

---

## üîó Related Master Prompts

**Depends On:**
- Master Prompt 001: Phase 0.B - Project Scaffolding ‚úÖ COMPLETE

**Blocks:**
- Master Prompt 003: Phase 2 - Real-Time Chat (1-on-1 Messaging)
- All subsequent feature prompts (contacts, groups, moments, etc.)

**Related:**
- `.copilot/works/codex_next_priorities.md` - Detailed task queue
- `work_reports/00_FEATURE_CHECKLIST.md` - Phase 1 feature tracking
- `.copilot/skills/expo-mobile-development/SKILL.md` - Mobile dev patterns
- `.copilot/skills/nestjs-api-development/SKILL.md` - Backend patterns

---

**Status:** NOT STARTED  
**Created:** 2026-02-04 16:20 JST  
**Start Date:** TBD  
**End Date:** TBD  
**Version:** 1.0
